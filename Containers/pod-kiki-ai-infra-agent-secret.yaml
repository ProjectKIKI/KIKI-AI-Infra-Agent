---
apiVersion: v1
kind: Secret
metadata:
  name: os-clouds
type: Opaque
data:
  # clouds.yaml 파일을 base64로 인코딩한 값
  clouds.yaml: <BASE64_ENCODED_CLOUDS_YAML>

---
apiVersion: v1
kind: Secret
metadata:
  name: k8s-kubeconfig
type: Opaque
data:
  # kubeconfig 파일(~/.kube/config 등)을 base64로 인코딩한 값
  config: <BASE64_ENCODED_KUBECONFIG>

---
apiVersion: v1
kind: Pod
metadata:
  name: kiki-ai-infra-agent
spec:
  hostNetwork: true
  restartPolicy: Always

  # Podman 네트워크를 쓰는 경우 (podman kube play 시):
  # Podman이 이 필드를 해석해서 해당 네트워크에 붙여줌
  network:
    - name: podman

  containers:
    - name: llama-server
      image: ghcr.io/ggerganov/llama.cpp:server
      args:
        - "--model"
        - "/models/data.gguf"
        - "--host"
        - "0.0.0.0"
        - "--port"
        - "8080"
        - "--ctx-size"
        - "4096"
        - "--n-gpu-layers"
        - "0"
        # CPU 성능 관련 옵션
        - "--threads"
        - "8"          # 물리/논리 코어 수에 맞게 조정
        - "--batch-size"
        - "512"        # 한 번에 처리할 토큰 배치 크기
        - "--ubatch-size"
        - "32"         # 내부 마이크로 배치, 너무 크면 레이턴시 증가
        - "--numa"
        - "distribute" # 멀티 소켓이면 NUMA 분산
      volumeMounts:
        - name: models
          mountPath: /models/data.gguf
          readOnly: true

    - name: ansible-agent
      image: localhost/llama-ansible-agent:latest
      env:
        - name: MODEL_URL
          value: http://127.0.0.1:8080/v1
        - name: API_KEY
          value: sk-noauth
        - name: WORK_DIR
          value: /work

        # OpenStack 인증 관련 (clouds.yaml 기반)
        - name: OS_CLIENT_CONFIG_FILE
          value: /etc/openstack/clouds.yaml
        # clouds.yaml 안에 정의된 cloud 이름 (예: lab)
        - name: OS_CLOUD
          value: lab

        # Kubernetes 인증 (kubeconfig 기반)
        - name: KUBECONFIG
          value: /etc/kubernetes/kubeconfig

      volumeMounts:
        - name: sshkeys
          mountPath: /home/agent/.ssh
          readOnly: true
        - name: work
          mountPath: /work

        # OpenStack/K8s 인증 파일을 Secret에서 마운트
        - name: os-clouds
          mountPath: /etc/openstack
          readOnly: true
        - name: k8s-kubeconfig
          mountPath: /etc/kubernetes
          readOnly: true

      ports:
        - containerPort: 8082
          hostPort: 8082

  volumes:
    - name: models
      hostPath:
        path: /root/models/data.gguf   # 모델 파일이 있는 위치(호스트)
        type: File

    - name: sshkeys
      hostPath:
        path: /root/.ssh
        type: Directory

    - name: work
      hostPath:
        path: /data/agent-work
        type: DirectoryOrCreate

    # 위에서 정의한 Secret을 Pod에 마운트
    - name: os-clouds
      secret:
        secretName: os-clouds
    - name: k8s-kubeconfig
      secret:
        secretName: k8s-kubeconfig