---
apiVersion: v1
kind: Secret
metadata:
  name: os-clouds
type: Opaque
data:
  # clouds.yaml 파일을 base64로 인코딩한 값
  clouds.yaml: <BASE64_ENCODED_CLOUDS_YAML>

---
apiVersion: v1
kind: Secret
metadata:
  name: k8s-kubeconfig
type: Opaque
data:
  # kubeconfig 파일(~/.kube/config 등)을 base64로 인코딩한 값
  config: <BASE64_ENCODED_KUBECONFIG>

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kiki-models-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # 필요하면 storageClassName 지정
  # storageClassName: nfs-client

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kiki-agent-db-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  # storageClassName: nfs-client

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kiki-work
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  # storageClassName: nfs-client  

---
apiVersion: v1
kind: Pod
metadata:
  name: kiki-ai-infra-agent
spec:
  hostNetwork: true
  restartPolicy: Always
  network: podman
  containers:
    # 1) llama.cpp 서버
    - name: llama-server
      image: ghcr.io/ggerganov/llama.cpp:server
      args: ["--model","/models/data.gguf",
             "--host","0.0.0.0","--port","8080",
             "--ctx-size","8192","--n-gpu-layers","0"]
      volumeMounts:
        - name: models
          mountPath: /models

    # 2) KIKI agentd (login / history / RAG)
    - name: kiki-agentd
      image: localhost/kiki-llm/kiki-ai-infra-agent:latest
      ports:
        - containerPort: 8082
      env:
        - name: KIKI_UPSTREAM_LLM_BASE_URL
          value: "http://127.0.0.1:8080"
        - name: KIKI_LLM_MODEL
          value: "local-llama"
        - name: KIKI_AGENT_DB_PATH
          value: "/app/data/kiki_agent.db"
      volumeMounts:
        - name: sshkeys
          mountPath: /home/agent/.ssh
        - name: work
          mountPath: /work
        - name: agent-db
          mountPath: /app/data

    # 3) Web UI
    - name: kiki-web
      image: localhost/kiki-llm/kiki-web:latest
      ports:
        - containerPort: 8082
          hostPort: 8082
      env:
        - name: KIKI_AGENT_BASE_URL
          value: "http://127.0.0.1:8082"
      volumeMounts:
        - name: work
          mountPath: /work

  volumes:
    # GGUF 모델 (PVC)
    - name: models
      persistentVolumeClaim:
        claimName: kiki-models-pvc

    # SSH 키 (여기는 hostPath 유지, 필요하면 PVC로 따로 분리 가능)
    - name: sshkeys
      hostPath:
        path: /root/.ssh
        type: Directory

    # 작업 디렉터리 (work) – 필요하면 나중에 이것도 PVC로 빼도 됨
    - name: work
      persistentVolumeClaim:
        claimName: kiki-work

    # 로그인/RAG DB (PVC)
    - name: agent-db
      persistentVolumeClaim:
        claimName: kiki-agent-db-pvc